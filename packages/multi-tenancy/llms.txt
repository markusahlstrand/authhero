# @authhero/multi-tenancy

> Multi-tenancy support for AuthHero - organization-based access control and per-tenant database isolation.

## Overview

This package provides enterprise multi-tenancy capabilities, enabling SaaS platforms to manage multiple isolated tenants with organization-based access control.

## Installation

```bash
npm install @authhero/multi-tenancy
```

## Features

- ðŸ” **Organization-based Access Control** - JWT tokens with `org_id` claims
- ðŸ’¾ **Database Isolation** - Per-tenant databases (D1, Turso, custom)
- âš™ï¸ **Settings Inheritance** - Child tenants inherit from main tenant
- ðŸŒ **Subdomain Routing** - Automatic subdomain-to-tenant resolution
- ðŸ”„ **Tenant Lifecycle** - Automated provisioning/deprovisioning
- ðŸª **Hooks Integration** - Seamless AuthHero hooks system
- ðŸ“¡ **Resource Server Sync** - Sync APIs across all tenants

## Quick Start

```typescript
import { Hono } from "hono";
import { createAuthhero } from "authhero";
import { setupMultiTenancy } from "@authhero/multi-tenancy";

const multiTenancy = setupMultiTenancy({
  accessControl: {
    controlPlaneTenantId: "control_plane",
    defaultPermissions: ["tenant:admin"],
  },
});

const app = new Hono();

// Apply middleware
app.use("*", multiTenancy.middleware);

// Mount management routes
app.route("/management", multiTenancy.app);

// Mount AuthHero with hooks
app.route("/", createAuthhero({
  dataAdapter: env.data,
  hooks: multiTenancy.hooks,
}));
```

## Key Concepts

### Organization-Tenant Model

Organizations on a "main" (control plane) tenant represent and control access to child tenants. Each organization maps to exactly one child tenant.

```
Main Tenant (Control Plane)
â”œâ”€â”€ Organization A â†’ Tenant A (isolated database)
â”œâ”€â”€ Organization B â†’ Tenant B (isolated database)
â””â”€â”€ Organization C â†’ Tenant C (isolated database)
```

### Token-Based Access Control

Access controlled via `org_id` claim in JWT tokens:

| Token Type | Access |
|------------|--------|
| No `org_id` | Main tenant only |
| With `org_id` | Matching child tenant |

### Silent Authentication (Tenant Switching)

```typescript
// Switch to a specific tenant
const token = await getAccessTokenSilently({
  authorizationParams: {
    organization: "tenant-id",
  },
});
```

## Database Isolation

Per-tenant databases for complete data isolation:

```typescript
import { setupMultiTenancy } from "@authhero/multi-tenancy";

const multiTenancy = setupMultiTenancy({
  databaseIsolation: {
    getAdapters: async (tenantId) => {
      // Return data adapters for the tenant
      return adaptersForTenant(tenantId);
    },
    onProvision: async (tenantId) => {
      // Optional: Called when a new tenant is created
    },
    onDeprovision: async (tenantId) => {
      // Optional: Called when a tenant is deleted
    },
  },
});
```

## Resource Server Synchronization

Automatically sync API configurations across tenants:

```typescript
import {
  createResourceServerSyncHooks,
  createTenantResourceServerSyncHooks,
  createRoleSyncHooks,
  createTenantRoleSyncHooks,
} from "@authhero/multi-tenancy";

const resourceServerHooks = createResourceServerSyncHooks({
  mainTenantId: "main",
  getChildTenantIds: async () => {
    const { tenants } = await adapters.tenants.list();
    return tenants.filter(t => t.id !== "main").map(t => t.id);
  },
  getAdapters: async (tenantId) => {
    return adapters.forTenant(tenantId);
  },
});
```

## Subdomain Routing

Map subdomains to tenants:

```typescript
const multiTenancy = setupMultiTenancy({
  subdomainRouting: {
    baseDomain: "example.com",
    resolver: async (subdomain) => {
      // customer1.example.com â†’ tenant-customer1
      return `tenant-${subdomain}`;
    },
  },
});
```

## Configuration

```typescript
interface MultiTenancyConfig {
  accessControl: {
    controlPlaneTenantId: string;
    defaultPermissions: string[];
  };
  databaseIsolation?: {
    getAdapters: (tenantId: string) => Promise<DataAdapters>;
    onProvision?: (tenantId: string) => Promise<void>;
    onDeprovision?: (tenantId: string) => Promise<void>;
  };
  subdomainRouting?: {
    baseDomain: string;
    resolver: (subdomain: string) => Promise<string>;
  };
  settingsInheritance?: {
    inheritFrom: string;
    fields: string[];
  };
}
```

## Documentation

- [Architecture](https://authhero.net/packages/multi-tenancy/architecture)
- [Database Isolation](https://authhero.net/packages/multi-tenancy/database-isolation)
- [API Reference](https://authhero.net/packages/multi-tenancy/api-reference)

## Key Files

- `src/index.ts` - Main `setupMultiTenancy()` function and exports
- `src/plugin.ts` - Plugin interface for AuthHero
- `src/middleware/` - Tenant resolution middleware
- `src/hooks/` - AuthHero hooks (database, access control, resource server sync, role sync)
- `src/routes/` - OpenAPI routes for tenant management
- `src/types.ts` - TypeScript type definitions
- `src/utils/` - Utility functions

## License

MIT License
