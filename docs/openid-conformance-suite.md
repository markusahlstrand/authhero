# OpenID Conformance Suite Testing

This guide explains how to run the [OpenID Foundation Conformance Suite](https://gitlab.com/openid/conformance-suite) against your local AuthHero environment.

## Prerequisites

- Docker and Docker Compose installed
- Git
- Node.js 18+
- macOS: Additional Docker networking configuration required (see below)

## Quick Start (Recommended)

The easiest way to run conformance tests is using `create-authhero` with the `--conformance` flag:

```bash
# 1. Create a new AuthHero project with conformance test clients
npx create-authhero my-conformance-test --template local --conformance

# Or with a custom alias for the conformance suite
npx create-authhero my-conformance-test --template local --conformance --conformance-alias my-test-alias

# 2. Start the AuthHero server (runs on https://localhost:3000 with self-signed certs)
cd my-conformance-test
npm run dev

# 3. Set up the conformance suite (one-time, in another terminal)
git clone https://gitlab.com/openid/conformance-suite.git ~/conformance-suite
cd ~/conformance-suite

# macOS ONLY: Fix Docker networking to allow container to reach host
# Add this to docker-compose-dev-mac.yml under the 'server' service:
#   extra_hosts:
#     - "host.docker.internal:host-gateway"

docker-compose -f docker-compose-dev-mac.yml up -d  # macOS
# OR
docker-compose -f docker-compose-dev.yml up -d      # Linux

# 4. Open https://localhost.emobix.co.uk:8443 in your browser
# (You may need to bypass certificate warnings - in Chrome type "thisisunsafe")
```

### Using package.json scripts (in the monorepo)

If you're working in the authhero monorepo, convenience scripts are available:

```bash
# Set up the conformance suite (one-time)
pnpm conformance:setup

# Start the conformance suite
pnpm conformance:start

# Stop the conformance suite
pnpm conformance:stop
```

### Test Clients

After setup, these test clients are available:

| Client ID         | Client Secret            |
| ----------------- | ------------------------ |
| conformance-test  | conformanceTestSecret123 |
| conformance-test2 | conformanceTestSecret456 |

The `create-authhero --conformance` command generates a `conformance-config.json` file that can be pasted into the conformance suite's JSON configuration tab.

---

## Manual Setup

If you prefer to set things up manually:

### 1. Clone the Conformance Suite

```bash
# Clone the conformance suite (outside the authhero directory)
cd ~
git clone https://gitlab.com/openid/conformance-suite.git
cd conformance-suite
```

### 2. Configure Docker Networking (macOS ONLY)

On macOS, Docker containers cannot reach `host.docker.internal` by default. You need to add extra host configuration:

Edit `docker-compose-dev-mac.yml` and add under the `server` service:

```yaml
services:
  server:
    # ... existing configuration ...
    extra_hosts:
      - "host.docker.internal:host-gateway"
```

This allows the conformance suite container to access your local AuthHero server at `host.docker.internal:3000`.

### 3. Start the Conformance Suite

**No build step required!** The conformance suite uses pre-built Docker images.

For macOS:

```bash
docker-compose -f docker-compose-dev-mac.yml up -d
```

For Linux:

```bash
docker-compose -f docker-compose-dev.yml up -d
```

The conformance suite will be available at `https://localhost.emobix.co.uk:8443/`

> **Note**: You'll get a certificate warning. In Chrome on Mac, you can type `thisisunsafe` to bypass it.

### 4. Start AuthHero with HTTPS

AuthHero must run with HTTPS and include `host.docker.internal` in the certificate for Docker access:

Using `create-authhero`:

```bash
npx create-authhero auth-server --template local --conformance
cd auth-server
npm run dev  # Automatically generates proper certificates
```

The auth-server automatically:

- Generates self-signed certificates with `host.docker.internal` as a Subject Alternative Name
- Configures the issuer as `https://host.docker.internal:3000/` for Docker compatibility
- Creates conformance test clients with proper callback URLs

### 5. Configure the Test

1. Visit `https://localhost.emobix.co.uk:8443/`
2. Select "OIDCC: OpenID Provider Certification" test plan
3. Switch to the "JSON" tab
4. Paste the AuthHero configuration from `conformance-config.json` (auto-generated by `create-authhero --conformance`)
5. Click "Start Test Plan"

## AuthHero Test Configuration

If you used `create-authhero --conformance`, a `conformance-config.json` file was generated with the correct configuration. Otherwise, use this:

```json
{
  "alias": "authhero-local",
  "description": "AuthHero Conformance Test",
  "server": {
    "discoveryUrl": "https://host.docker.internal:3000/.well-known/openid-configuration"
  },
  "client": {
    "client_id": "conformance-test",
    "client_secret": "conformanceTestSecret123"
  },
  "client2": {
    "client_id": "conformance-test2",
    "client_secret": "conformanceTestSecret456"
  },
  "resource": {
    "resourceUrl": "https://host.docker.internal:3000/userinfo"
  }
}
```

### Important Notes

- **HTTPS required**: AuthHero must run with HTTPS (not HTTP) for conformance tests
- `host.docker.internal` allows the Docker container to reach your local machine
- The certificate must include `host.docker.internal` as a Subject Alternative Name (SAN)
- On macOS, you must add `extra_hosts` to docker-compose configuration (see Manual Setup above)
- Make sure the client IDs and secrets match what's configured in AuthHero

## Setting Up Additional Clients

You'll need to create additional clients in AuthHero for full conformance testing. Add these to your demo setup or run via API:

### Client 2 (for multi-client tests)

```typescript
await dataAdapter.clients.create("main", {
  client_id: "conformance-client2",
  client_secret: "conformanceSecret2",
  name: "Conformance Client 2",
  callbacks: [
    "https://localhost.emobix.co.uk:8443/test/a/authhero-local/callback",
  ],
  allowed_logout_urls: ["https://localhost.emobix.co.uk:8443/"],
  web_origins: ["https://localhost.emobix.co.uk:8443"],
});
```

## Callback URL Setup

For the conformance suite to work properly, configure these callback URLs in your AuthHero client:

```
https://localhost.emobix.co.uk:8443/test/a/authhero-local/callback
https://localhost:8443/test/a/authhero-local/callback
```

### Callback URLs

For the conformance suite to work properly, these callback URLs are automatically configured when using `create-authhero --conformance`:

```
https://localhost.emobix.co.uk:8443/test/a/authhero-local/callback
https://localhost:8443/test/a/authhero-local/callback
```

Replace `authhero-local` with your custom alias if you used `--conformance-alias`.

## Network Configuration

### macOS Docker Networking

Docker Desktop on Mac requires special configuration for containers to reach the host:

1. **Add extra_hosts** to docker-compose-dev-mac.yml:

   ```yaml
   services:
     server:
       extra_hosts:
         - "host.docker.internal:host-gateway"
   ```

2. **Use host.docker.internal** in conformance config instead of localhost:
   ```json
   "discoveryUrl": "https://host.docker.internal:3000/.well-known/openid-configuration"
   ```

### Linux Docker Networking

On Linux, `host.docker.internal` is not available by default. Options:

1. **Use host network mode** (simplest):

   ```bash
   docker-compose -f docker-compose-dev.yml up -d
   ```

   Then use `http://localhost:3000` in your config.

2. **Add extra_hosts** (similar to macOS):
   ```yaml
   extra_hosts:
     - "host.docker.internal:172.17.0.1"
   ```

### Using localhost.emobix.co.uk

The conformance suite uses `localhost.emobix.co.uk` which automatically resolves to `127.0.0.1`. No `/etc/hosts` modification needed.

## Running Specific Test Plans

### Basic OpenID Connect Core

1. Open `https://localhost.emobix.co.uk:8443`
2. Select "OIDCC: Basic Certification Profile Authorization server test"
3. Switch to "JSON" tab
4. Paste configuration from `conformance-config.json`
5. Click "Start Test Plan"

### Implicit Flow

For implicit flow testing, use "OIDCC: Implicit Certification Profile Authorization server test"

### Hybrid Flow

For hybrid flow testing, use "OIDCC: Hybrid Certification Profile Authorization server test"

## Troubleshooting

### macOS: Conformance Suite Can't Reach AuthHero

**Problem**: Tests fail with connection errors or "cannot resolve host.docker.internal"

**Solution**: Add extra host configuration to docker-compose-dev-mac.yml:

```yaml
services:
  server:
    # ... existing configuration ...
    extra_hosts:
      - "host.docker.internal:host-gateway"
```

Then restart the conformance suite:

```bash
docker-compose -f docker-compose-dev-mac.yml down
docker-compose -f docker-compose-dev-mac.yml up -d
```

### Certificate/SSL Errors

**Problem**: Conformance tests fail with SSL/TLS errors

**Solution**: Ensure your AuthHero server certificates include `host.docker.internal` as a Subject Alternative Name (SAN):

```bash
# Using create-authhero (handles this automatically)
npx create-authhero auth-server --template local --conformance
cd auth-server
npm run dev

# Manual certificate generation
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes \
  -subj "/CN=localhost" \
  -addext "subjectAltName=DNS:localhost,DNS:host.docker.internal,IP:127.0.0.1"
```

### Browser Certificate Warnings

The conformance suite UI uses self-signed certificates. Options:

1. **Chrome/Edge**: Type `thisisunsafe` when blocked (nothing appears on screen, just type it)
2. **Firefox**: Click "Advanced" → "Accept the Risk and Continue"
3. **Safari**: Click "Show Details" → "visit this website"

### Tests Failing with "EnsureMinimumAuthorizationCodeEntropy"

**Problem**: Authorization code entropy is too low

**Solution**: AuthHero 4.12.0+ automatically generates high-entropy codes (192 bits). Make sure you're using workspace packages, not npm published versions:

```json
{
  "dependencies": {
    "authhero": "workspace:*",
    "@authhero/kysely-adapter": "workspace:*"
  }
}
```

### Tests Failing with "EnsureIdTokenDoesNotContainNonRequestedClaims"

**Problem**: id_token contains claims that weren't requested via scopes

**Solution**: AuthHero 4.12.0+ properly respects OIDC scope-to-claim mapping:
- `openid` scope: Only `sub`, `iss`, `aud`, and standard JWT claims
- `profile` scope: Adds `name`, `nickname`, `picture`, `given_name`, `family_name`, `locale`
- `email` scope: Adds `email`, `email_verified`

Make sure your test configuration requests the appropriate scopes.

### Tests Failing with Redirect Errors

Ensure callback URLs are properly configured in both:

- AuthHero client configuration (automatically set with `--conformance`)
- Conformance suite test configuration (use the alias from `--conformance-alias`)

### Discovery Document Issues

Verify your AuthHero instance returns a valid discovery document:

```bash
curl -k https://localhost:3000/.well-known/openid-configuration | jq
```

The `-k` flag bypasses certificate verification for self-signed certificates.

## Test Clients

When using `create-authhero --conformance`, these test clients are automatically created:

| Client ID          | Client Secret            | Authentication Method |
| ------------------ | ------------------------ | --------------------- |
| conformance-test   | conformanceTestSecret123 | client_secret_post    |
| conformance-test2  | conformanceTestSecret456 | client_secret_post    |

Both clients are pre-configured with:

- Callback URLs for localhost.emobix.co.uk:8443
- Allowed logout URLs
- Web origins for CORS

## Common Issues & Solutions

### INFO: ValidateClientJWKsPrivatePart - Skipped

This is normal! This check only applies to clients using `private_key_jwt` authentication. The conformance test clients use `client_secret_post`, so this validation is correctly skipped.

## Resources

- [Conformance Suite Wiki](https://gitlab.com/openid/conformance-suite/-/wikis/home)
- [OpenID Certification Instructions](https://openid.net/certification/instructions/)
- [Conformance Suite Docker Guide](https://gitlab.com/openid/conformance-suite/-/wikis/Developers/Build-&-Run)
- [OIDC Core Specification](https://openid.net/specs/openid-connect-core-1_0.html)
